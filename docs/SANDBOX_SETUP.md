# 🚀 Настройка выполнения терминальных команд

CapyCode использует **E2B** (e2b.dev) для выполнения кода в изолированных контейнерах.
Это позволяет:
- ✅ Запускать реальные терминальные команды
- ✅ Запускать `npm install`, `expo start`
- ✅ Получать QR-код для Expo Go
- ✅ Видеть реальный вывод команд

## 📋 Шаги настройки

### 1. Получите E2B API ключ

1. Зайдите на [https://e2b.dev](https://e2b.dev)
2. Создайте бесплатный аккаунт
3. Перейдите в Dashboard → API Keys
4. Скопируйте ваш API ключ

### 2. Добавьте ключ в проект

Создайте файл `.env.local` в папке `frontend/`:

```env
# E2B Sandbox для выполнения кода
E2B_API_KEY=e2b_your_api_key_here

# Опционально: кастомный шаблон E2B с Node.js + Expo
E2B_TEMPLATE=base
```

### 3. Установите E2B SDK

```bash
cd frontend
npm install e2b @e2b/code-interpreter
```

### 4. Создайте кастомный шаблон E2B (опционально)

Для лучшей производительности создайте шаблон с предустановленными зависимостями:

```bash
# Установите E2B CLI
npm install -g @e2b/cli

# Создайте новый шаблон
e2b template init expo-template

# В шаблоне установите:
npm install -g expo-cli @expo/ngrok
```

## 🔧 Как это работает

```
┌─────────────────────────────────────────────────────────────────┐
│                        CapyCode (Browser)                        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │  AI Panel    │───>│  Terminal    │───>│  Preview     │       │
│  │  (генерация) │    │  (команды)   │    │  (QR код)    │       │
│  └──────────────┘    └──────────────┘    └──────────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ API Request
┌─────────────────────────────────────────────────────────────────┐
│                     Next.js API Route                            │
│                    /api/sandbox/route.ts                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ E2B SDK
┌─────────────────────────────────────────────────────────────────┐
│                        E2B Sandbox                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Isolated Linux Container                     │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  - Node.js 18+                                       │ │   │
│  │  │  - npm/yarn/pnpm                                     │ │   │
│  │  │  - Expo CLI                                          │ │   │
│  │  │  - Git                                               │ │   │
│  │  │  - Full filesystem access                            │ │   │
│  │  │  - Port forwarding (8081 → public URL)               │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Output: QR Code URL → exp://tunnel.expo.dev/xxx                │
└─────────────────────────────────────────────────────────────────┘
```

## 💰 Стоимость E2B

| План | Включено | Цена |
|------|----------|------|
| Free | 100 часов/месяц | $0 |
| Pro | 500 часов/месяц | $25/мес |
| Enterprise | Unlimited | Custom |

Для разработки и тестирования Free плана достаточно!

## 🔄 Альтернативные платформы

Если E2B не подходит, можно использовать:

### 1. StackBlitz WebContainers
- ✅ Работает полностью в браузере
- ✅ Не требует серверной части
- ❌ Ограничен Node.js (нет Expo tunnel)

```bash
npm install @stackblitz/sdk
```

### 2. CodeSandbox API
- ✅ Популярная платформа
- ✅ Хороший UI
- ❌ Нет публичного API для sandboxes

### 3. Gitpod API
- ✅ Полноценные dev environments
- ❌ Дороже
- ❌ Более сложная интеграция

### 4. Railway / Fly.io
- ✅ Можно деплоить контейнеры
- ❌ Не предназначены для dev environments
- ❌ Требуют больше настройки

## 📱 Как получить QR-код для Expo Go

После настройки E2B:

1. Пользователь нажимает "Запустить терминал"
2. Вводит `expo start` или нажимает кнопку "Start Expo"
3. E2B sandbox запускает:
   ```bash
   npm install
   npx expo start --tunnel
   ```
4. Expo создает tunnel через ngrok
5. CapyCode парсит URL (`exp://...`) из stdout
6. Генерируется QR-код
7. Пользователь сканирует в Expo Go

## 🐛 Troubleshooting

### "E2B API key not configured"
Добавьте `E2B_API_KEY` в `.env.local`

### "Session expired"
Сессии E2B живут 1 час. Создайте новую.

### "Port not available"
E2B автоматически пробрасывает порты. Проверьте логи.

### QR-код не работает
Убедитесь что Expo запущен с `--tunnel` флагом.
